<%
  summ_balls ||= {}
  summ_balls[project.id] = {}
  summ_balls[project.id][:render_summ] = true
%>

<ul class="listing participants">
  <% project.participants.active.each_with_index do |participant, index| %>
    <%
      summ_balls[project.id][participant.id] = {:period => 0.0, :summ => 0.0}
    %>
    <li class="participant_<%= index+1 %>">
      <div class="participant object">
        <h3><%= h(participant.name) %></h3>
      </div>
    </li>
  <% end -%>
</ul>

<div class="rating">
  <div class="wrapper">
    <% Gpoday.find(:all, :order => :date).each do | gpoday | %>
      <div class="gpoday <%= gpoday.kt? ? 'kt' : nil %>">
        <span class="date"><%= I18n.localize(gpoday.date) + "#{gpoday.kt? ? ' (КТ)' : nil}" %></span>
        <ul>
          <% project.participants.active.each_with_index do |participant, index| %>
            <%
              visitation = participant.visitation_for_gpoday(gpoday)
              summ_balls[project.id][participant.id][:period] += visitation.rate || 0.0
              summ_balls[project.id][participant.id][:summ] += visitation.rate || 0.0
            %>
            <li id="<%= project.chair.id %>_<%= project.id %>_<%= visitation.id %>">
              <%= visitation.rate.nil? ? "<span class='empty ratio'>&mdash;</span>" : "<span class='ratio'>#{participant.visitation_for_gpoday(gpoday).rate}</span>" %>
              <%#= link_to t('edit'), edit_chair_project_visitation_url(project.chair, project, visitation, :context => @context), :class => "edit" if permitted_to?(:update, project) %>
              <% if gpoday.kt? %>
                <%= content_tag :span, summ_balls[project.id][participant.id][:period], :class=>"period", :title => "за текущий период" %>
                <%= content_tag :span, " / #{summ_balls[project.id][participant.id][:summ]}", :class=>"summ", :title => "суммарно" if summ_balls[project.id][:render_summ] %>
              <% summ_balls[project.id][participant.id][:period] = 0.0 %>
              <%  end %>
            </li>
          <% end %>
        </ul>
      </div>
    <% end %>
  </div>
</div>

